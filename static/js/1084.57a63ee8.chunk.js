(self.webpackChunk_kne_components_core=self.webpackChunk_kne_components_core||[]).push([[1084],{68474:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>q});var a=n(49338);const r="style_rich-editor__guy9h__RY4Bj",o="style_read-only__mFMiA__RY4Bj",s="style_hidden__IUpV4__RY4Bj",i="style_no-border__bKLqc__RY4Bj";var l=n(97433),c=n.n(l),u=n(42415),d=n.n(u),h=n(43682),p=n(66195),f=n.n(p),m=(n(86009),n(7101)),g=n.n(m),v=n(86122),y=n(2508),b=n(44439),w=n(16907),x=n.n(w);const _=(t,e)=>{let n=t.split(","),a=n[0].match(/:(.*?);/)[1]||"image/jpeg",r=a.split("/")[1]||"jpg";const o=window.atob(n[1]);let s=o.length;const i=new Uint8Array(s);for(;s--;)i[s]=o.charCodeAt(s);return new File([i],"".concat(e,".").concat(r),{type:a})},O=t=>!!t&&/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/.test(t);var j=n(80184);const k=[[{header:[1,2,3,4,5,6,!1]}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],["image"],["link"],["clean"]],I=t=>{const e=document.createElement("div");return e.innerHTML=t,{text:e.innerText}},A=t=>{const e=document.createElement("A");return e.href=t,e},P=t=>{let{className:e,readOnly:n,preview:a,onBlur:l,placeholder:u,hideToolbar:p,border:m,domain:w,folder:P,type:T,maxHeight:E,...S}=t;const[q,R]=c()(S),B=(0,v.useRef)(!1),M=(0,v.useRef)(null),N=d()((()=>{l&&l()})),{ossApi:C,ossToStatic:F,ajax:D,urlToOss:L}=(0,h.usePreset)(),Y=(0,v.useMemo)((()=>q&&"[object Object]"===Object.prototype.toString.call(q)?q.hasOwnProperty("ops")?q:q.hasOwnProperty("blocks")?(t=>{const e=[];for(let n=0;n<(t.blocks||[]).length;n++){const a=t.blocks[n];if(a.data&&("header"===a.type&&(e.push({insert:"".concat(I(a.data.text).text)}),e.push({attributes:{header:a.data.level},insert:"\n"})),"paragraph"===a.type&&e.push({insert:"".concat(I(a.data.text).text,"\n")}),"delimiter"===a.type&&(e.push({attributes:{color:"#000000",size:"huge",bold:!0},insert:" * * *"}),e.push({attributes:{align:"center"},insert:"\n"})),"image"===a.type&&e.push({insert:{image:a.data.file.hasOwnProperty("id")?"".concat(window.location.origin,"/attachment/").concat(a.data.file.id,".png?id=").concat(a.data.file.id,"&originalName=").concat(a.data.file.filename):a.data.file.url}}),"list"===a.type&&(a.data.items||[]).map((t=>{e.push.apply(e,[{insert:"".concat(I(t.content).text)},{attributes:{list:"bullet"},insert:"\n"}])})),"attaches"===a.type)){const t=(0,b.get)(a.data,"file.title")||(0,b.get)(a.data,"title")||"",n=(0,b.get)(a.data,"file.extension")||t.substring(t.lastIndexOf(".")+1),r=a.data.file.hasOwnProperty("id")?"".concat(window.location.origin,"/attachment/").concat(a.data.file.id,".").concat(n,"?id=").concat(a.data.file.id,"&originalName=").concat(t):a.data.file.url;e.push.apply(e,[{attributes:{link:r},insert:t},{insert:"\n"}])}}return{ops:e}})(q):q:q&&"string"===typeof q?{ops:[{insert:"".concat(I(q).text,"\n")}]}:{ops:[]}),[q]),H=((0,v.useMemo)((()=>!(!q||"[object Object]"!==Object.prototype.toString.call(q)||!q.hasOwnProperty("blocks"))),[q]),async(t,e)=>{const n=A(t),a=new URLSearchParams(n.search),r=null===a||void 0===a?void 0:a.get("id"),o=n.pathname.substring(n.pathname.lastIndexOf("/")+1),s=r||o.substring(0,o.lastIndexOf("."));if(s){const{data:n}=await D((0,b.merge)({},C,{params:{id:s},showError:!1})),a=C.transformData?C.transformData(n):n.data;return a?await L({url:x()(a),folder:e}):t}const i=await L({url:t,folder:e});return i||t}),U=async()=>{const t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept","image/*"),t.click(),t.onchange=()=>{const e=t.files[0],n=y.message.loading("\u4e0a\u4f20\u4e2d...",0);F({file:e,folder:P}).then((t=>{var e;let a=null===M||void 0===M||null===(e=M.current)||void 0===e?void 0:e.getEditor();const r=a.getSelection().index;a.insertEmbed(r,"image",t,"api"),a.setSelection(r+1),n()}))}},z=async()=>{var t,e;if(M.current){var n=null===(t=N.current)||void 0===t?void 0:t.querySelectorAll(".ql-container img");for(let t=0;t<n.length;t++){const e=n[t];let a=A(e.src);const r=new Image;r.src=e.src;const o=w.some((t=>t.host===a.hostname)),s=w.some((t=>t.host===a.hostname&&!0===t.update));if(o)r.onerror=()=>{s&&H(e.src,P).then((t=>{e.src=t}))};else if(/^data:image/.test(e.src)){const t=(0,b.uniqueId)("base64_")+(new Date).getTime(),n=_(e.src,t);F({file:n,folder:P}).then((async t=>{e.src=t}))}else O(e.src)&&L({url:x()(e.src),folder:P}).then((t=>{t&&(e.src=t)}))}var a=null===(e=N.current)||void 0===e?void 0:e.querySelectorAll(".ql-container a");for(let t=0;t<a.length;t++){const e=a[t];if(O(e.href)){let t=A(e.href);w.some((e=>e.host===t.hostname&&!0===e.update))&&H(e.href,P).then((t=>{e.href=t}))}}}},V=(0,v.useMemo)((()=>({toolbar:{container:k,handlers:{image:t=>{U.call(void 0,S)}}}})),[]);return(0,v.useEffect)((()=>{B.current=!1;const t=setInterval((()=>{M.current&&M.current.editor&&(B.current=!0,z(),clearInterval(t))}),10);return()=>{t&&clearInterval(t)}}),[]),(0,j.jsx)("div",{ref:N,style:{"--max-height":E&&!(0,b.isNaN)(parseFloat(E))?parseFloat(E)+"px":""},className:g()(e,r,{[o]:a||n,[s]:a||p||n,[i]:!1===m}),children:(0,j.jsx)(f(),{ref:M,readOnly:n,modules:V,value:"html"===T?q:Y,placeholder:u,theme:"snow",onChange:async(t,e,n,a)=>{const r="html"===T?a.getHTML():a.getContents();z();const o="html"===T?r:await(async t=>{const e=(0,b.get)(t,"ops")||[];for(let n=0;n<e.length;n++){const t=e[n],a=(0,b.get)(t,"insert.image");if(a){let e=A(a);const n=w.some((t=>t.host===e.hostname)),r=w.some((t=>t.host===e.hostname&&!0===t.update));if(n){const e=r?await H(a,P):a;t.insert.image=e}else if(/^data:image/.test(a)){const e=(0,b.uniqueId)("base64_")+(new Date).getTime(),n=_(a,e),r=await F({file:n,folder:P});t.insert.image=r}else if(O(a)){const e=await L({url:x()(a),folder:P});t.insert.image=e||a}}}return{ops:e}})(r);R&&R(o)}})})};P.defaultProps={placeholder:"\u8bf7\u8f93\u5165",hideToolbar:!1,border:!0,value:null,readOnly:!1,preview:!1,defaultValue:{ops:[]},folder:"richEditor",domain:[{host:"localhost",update:!0},{host:"attachment.dev.fatalent.cn",update:!0},{host:"attachment.test.fatalent.cn",update:!0},{host:"attachment.fatalent.cn",update:!0},{host:"fat-dev-static.oss-cn-shanghai.aliyuncs.com"},{host:"fat-test-static.oss-cn-shanghai.aliyuncs.com"},{host:"fat-static.oss-cn-shanghai.aliyuncs.com"}]};const T=P,{useOnBlur:E}=a.hooks,S=t=>E(t)(T);S.Field=S.field=T;const q=S},31211:t=>{t.exports=function(t,e,n,a){for(var r=-1,o=null==t?0:t.length;++r<o;){var s=t[r];e(a,s,n(s),t)}return a}},38430:(t,e,n)=>{var a=n(87927);t.exports=function(t,e,n,r){return a(t,(function(t,a,o){e(r,t,n(t),o)})),r}},87927:(t,e,n)=>{var a=n(15358),r=n(63173)(a);t.exports=r},58645:t=>{t.exports=function(t,e){for(var n,a=-1,r=t.length;++a<r;){var o=e(t[a]);void 0!==o&&(n=void 0===n?o:n+o)}return n}},74629:(t,e,n)=>{var a=n(31211),r=n(38430),o=n(56025),s=n(93629);t.exports=function(t,e){return function(n,i){var l=s(n)?a:r,c=e?e():{};return l(n,t,o(i,2),c)}}},63173:(t,e,n)=>{var a=n(21473);t.exports=function(t,e){return function(n,r){if(null==n)return n;if(!a(n))return t(n,r);for(var o=n.length,s=e?o:-1,i=Object(n);(e?s--:++s<o)&&!1!==r(i[s],s,i););return n}}},21867:(t,e,n)=>{var a=n(2646),r=n(39753);t.exports=function(t,e,n){var o=null==t?0:t.length;return o?(e=n||void 0===e?1:r(e),a(t,0,(e=o-e)<0?0:e)):[]}},98444:(t,e,n)=>{var a=n(32526),r=n(74629),o=Object.prototype.hasOwnProperty,s=r((function(t,e,n){o.call(t,n)?t[n].push(e):a(t,n,[e])}));t.exports=s},70290:(t,e,n)=>{var a=n(71848);t.exports=function(t,e,n){var r=(n="function"==typeof n?n:void 0)?n(t,e):void 0;return void 0===r?a(t,e,void 0,n):!!r}},87151:(t,e,n)=>{var a=n(58645),r=n(52173);t.exports=function(t){return t&&t.length?a(t,r):0}},39753:(t,e,n)=>{var a=n(91495);t.exports=function(t){var e=a(t),n=e%1;return e===e?n?e-n:e:0}},32883:()=>{},20717:()=>{},86009:()=>{}}]);
//# sourceMappingURL=1084.57a63ee8.chunk.js.map