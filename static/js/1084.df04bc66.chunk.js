(self.webpackChunk_kne_components_core=self.webpackChunk_kne_components_core||[]).push([[1084],{68474:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>S});var a=n(49338);const r="style_rich-editor__guy9h__HxoH6",o="style_read-only__mFMiA__HxoH6",s="style_hidden__IUpV4__HxoH6",i="style_no-border__bKLqc__HxoH6";var l=n(97433),c=n.n(l),u=n(42415),d=n.n(u),h=n(43682),p=n(66195),f=n.n(p),m=(n(86009),n(7101)),g=n.n(m),v=n(86122),y=n(2508),b=n(44439),w=n(16907),x=n.n(w);const _=(t,e)=>{let n=t.split(","),a=n[0].match(/:(.*?);/)[1]||"image/jpeg",r=a.split("/")[1]||"jpg";const o=window.atob(n[1]);let s=o.length;const i=new Uint8Array(s);for(;s--;)i[s]=o.charCodeAt(s);return new File([i],"".concat(e,".").concat(r),{type:a})},O=t=>!!t&&/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/.test(t);var k=n(80184);const j=[[{header:[1,2,3,4,5,6,!1]}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],["image"],["link"],["clean"]],H=t=>{const e=document.createElement("div");return e.innerHTML=t,{text:e.innerText}},I=t=>{const e=document.createElement("A");return e.href=t,e},A=t=>{let{className:e,readOnly:n,preview:a,onBlur:l,placeholder:u,hideToolbar:p,border:m,domain:w,folder:A,type:P,maxHeight:T,...E}=t;const[S,q]=c()(E),M=(0,v.useRef)(!1),N=(0,v.useRef)(null),C=d()((()=>{l&&l()})),{ossApi:F,ossToStatic:D,ajax:L,urlToOss:R}=(0,h.usePreset)(),U=(0,v.useMemo)((()=>S&&"[object Object]"===Object.prototype.toString.call(S)?S.hasOwnProperty("ops")?S:S.hasOwnProperty("blocks")?(t=>{const e=[];for(let n=0;n<(t.blocks||[]).length;n++){const a=t.blocks[n];if(a.data&&("header"===a.type&&(e.push({insert:"".concat(H(a.data.text).text)}),e.push({attributes:{header:a.data.level},insert:"\n"})),"paragraph"===a.type&&e.push({insert:"".concat(H(a.data.text).text,"\n")}),"delimiter"===a.type&&(e.push({attributes:{color:"#000000",size:"huge",bold:!0},insert:" * * *"}),e.push({attributes:{align:"center"},insert:"\n"})),"image"===a.type&&e.push({insert:{image:a.data.file.hasOwnProperty("id")?"".concat(window.location.origin,"/attachment/").concat(a.data.file.id,".png?id=").concat(a.data.file.id,"&originalName=").concat(a.data.file.filename):a.data.file.url}}),"list"===a.type&&(a.data.items||[]).map((t=>{e.push.apply(e,[{insert:"".concat(H(t.content).text)},{attributes:{list:"bullet"},insert:"\n"}])})),"attaches"===a.type)){const t=(0,b.get)(a.data,"file.title")||(0,b.get)(a.data,"title")||"",n=(0,b.get)(a.data,"file.extension")||t.substring(t.lastIndexOf(".")+1),r=a.data.file.hasOwnProperty("id")?"".concat(window.location.origin,"/attachment/").concat(a.data.file.id,".").concat(n,"?id=").concat(a.data.file.id,"&originalName=").concat(t):a.data.file.url;e.push.apply(e,[{attributes:{link:r},insert:t},{insert:"\n"}])}}return{ops:e}})(S):S:S&&"string"===typeof S?{ops:[{insert:"".concat(H(S).text,"\n")}]}:{ops:[]}),[S]),z=((0,v.useMemo)((()=>!(!S||"[object Object]"!==Object.prototype.toString.call(S)||!S.hasOwnProperty("blocks"))),[S]),async(t,e)=>{const n=I(t),a=new URLSearchParams(n.search),r=null===a||void 0===a?void 0:a.get("id"),o=n.pathname.substring(n.pathname.lastIndexOf("/")+1),s=r||o.substring(0,o.lastIndexOf("."));if(s){const{data:n}=await L((0,b.merge)({},F,{params:{id:s},showError:!1})),a=F.transformData?F.transformData(n):n.data;return a?await R({url:x()(a),folder:e}):t}const i=await R({url:t,folder:e});return i||t}),B=async()=>{const t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept","image/*"),t.click(),t.onchange=()=>{const e=t.files[0],n=y.message.loading("\u4e0a\u4f20\u4e2d...",0);D({file:e,folder:A}).then((t=>{var e;let a=null===N||void 0===N||null===(e=N.current)||void 0===e?void 0:e.getEditor();const r=a.getSelection().index;a.insertEmbed(r,"image",t,"api"),a.setSelection(r+1),n()}))}},V=async()=>{var t,e;if(N.current){var n=null===(t=C.current)||void 0===t?void 0:t.querySelectorAll(".ql-container img");for(let t=0;t<n.length;t++){const e=n[t];let a=I(e.src);const r=new Image;r.src=e.src;const o=w.some((t=>t.host===a.hostname)),s=w.some((t=>t.host===a.hostname&&!0===t.update));if(o)r.onerror=()=>{s&&z(e.src,A).then((t=>{e.src=t}))};else if(/^data:image/.test(e.src)){const t=(0,b.uniqueId)("base64_")+(new Date).getTime(),n=_(e.src,t);D({file:n,folder:A}).then((async t=>{e.src=t}))}else O(e.src)&&R({url:x()(e.src),folder:A}).then((t=>{t&&(e.src=t)}))}var a=null===(e=C.current)||void 0===e?void 0:e.querySelectorAll(".ql-container a");for(let t=0;t<a.length;t++){const e=a[t];if(O(e.href)){let t=I(e.href);w.some((e=>e.host===t.hostname&&!0===e.update))&&z(e.href,A).then((t=>{e.href=t}))}}}},K=(0,v.useMemo)((()=>({toolbar:{container:j,handlers:{image:t=>{B.call(void 0,E)}}}})),[]);return(0,v.useEffect)((()=>{M.current=!1;const t=setInterval((()=>{N.current&&N.current.editor&&(M.current=!0,V(),clearInterval(t))}),10);return()=>{t&&clearInterval(t)}}),[]),(0,k.jsx)("div",{ref:C,style:{"--max-height":T&&!(0,b.isNaN)(parseFloat(T))?parseFloat(T)+"px":""},className:g()(e,r,{[o]:a||n,[s]:a||p||n,[i]:!1===m}),children:(0,k.jsx)(f(),{ref:N,readOnly:n,modules:K,value:"html"===P?S:U,placeholder:u,theme:"snow",onChange:async(t,e,n,a)=>{const r="html"===P?a.getHTML():a.getContents();V();const o="html"===P?r:await(async t=>{const e=(0,b.get)(t,"ops")||[];for(let n=0;n<e.length;n++){const t=e[n],a=(0,b.get)(t,"insert.image");if(a){let e=I(a);const n=w.some((t=>t.host===e.hostname)),r=w.some((t=>t.host===e.hostname&&!0===t.update));if(n){const e=r?await z(a,A):a;t.insert.image=e}else if(/^data:image/.test(a)){const e=(0,b.uniqueId)("base64_")+(new Date).getTime(),n=_(a,e),r=await D({file:n,folder:A});t.insert.image=r}else if(O(a)){const e=await R({url:x()(a),folder:A});t.insert.image=e||a}}}return{ops:e}})(r);q&&q(o)}})})};A.defaultProps={placeholder:"\u8bf7\u8f93\u5165",hideToolbar:!1,border:!0,value:null,readOnly:!1,preview:!1,defaultValue:{ops:[]},folder:"richEditor",domain:[{host:"localhost",update:!0},{host:"attachment.dev.fatalent.cn",update:!0},{host:"attachment.test.fatalent.cn",update:!0},{host:"attachment.fatalent.cn",update:!0},{host:"fat-dev-static.oss-cn-shanghai.aliyuncs.com"},{host:"fat-test-static.oss-cn-shanghai.aliyuncs.com"},{host:"fat-static.oss-cn-shanghai.aliyuncs.com"}]};const P=A,{useOnBlur:T}=a.hooks,E=t=>T(t)(P);E.Field=E.field=P;const S=E},31211:t=>{t.exports=function(t,e,n,a){for(var r=-1,o=null==t?0:t.length;++r<o;){var s=t[r];e(a,s,n(s),t)}return a}},38430:(t,e,n)=>{var a=n(87927);t.exports=function(t,e,n,r){return a(t,(function(t,a,o){e(r,t,n(t),o)})),r}},87927:(t,e,n)=>{var a=n(15358),r=n(63173)(a);t.exports=r},58645:t=>{t.exports=function(t,e){for(var n,a=-1,r=t.length;++a<r;){var o=e(t[a]);void 0!==o&&(n=void 0===n?o:n+o)}return n}},74629:(t,e,n)=>{var a=n(31211),r=n(38430),o=n(56025),s=n(93629);t.exports=function(t,e){return function(n,i){var l=s(n)?a:r,c=e?e():{};return l(n,t,o(i,2),c)}}},63173:(t,e,n)=>{var a=n(21473);t.exports=function(t,e){return function(n,r){if(null==n)return n;if(!a(n))return t(n,r);for(var o=n.length,s=e?o:-1,i=Object(n);(e?s--:++s<o)&&!1!==r(i[s],s,i););return n}}},21867:(t,e,n)=>{var a=n(2646),r=n(39753);t.exports=function(t,e,n){var o=null==t?0:t.length;return o?(e=n||void 0===e?1:r(e),a(t,0,(e=o-e)<0?0:e)):[]}},98444:(t,e,n)=>{var a=n(32526),r=n(74629),o=Object.prototype.hasOwnProperty,s=r((function(t,e,n){o.call(t,n)?t[n].push(e):a(t,n,[e])}));t.exports=s},70290:(t,e,n)=>{var a=n(71848);t.exports=function(t,e,n){var r=(n="function"==typeof n?n:void 0)?n(t,e):void 0;return void 0===r?a(t,e,void 0,n):!!r}},87151:(t,e,n)=>{var a=n(58645),r=n(52173);t.exports=function(t){return t&&t.length?a(t,r):0}},39753:(t,e,n)=>{var a=n(91495);t.exports=function(t){var e=a(t),n=e%1;return e===e?n?e-n:e:0}},32883:()=>{},20717:()=>{},86009:()=>{}}]);
//# sourceMappingURL=1084.df04bc66.chunk.js.map